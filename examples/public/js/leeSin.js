((e,t)=>{"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self)["@careteen/leesin"]=t()})(this,function(){var d=function(){return(d=Object.assign||function(e){for(var t,n=1,o=arguments.length;n<o;n++)for(var r in t=arguments[n])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e}).apply(this,arguments)},c={reportUrl:"http://localhost:10000/api",token:"",appVersion:"1.0.0",environment:"production",outtime:300,enableSPA:!1,autoSendPv:!1,isPage:!1,isAjax:!1,isResource:!1,isError:!1,isRecord:!1,isBehavior:!1,ignore:{ignoreErrors:[],ignoreUrls:[],ignoreApis:["/api/v1/report/web","livereload.js?snipver=1","/sockjs-node/info"]},behavior:{console:["log","error"],click:!0},maxLength:1e3};var u={page:"",sid:"",sBegin:Date.now(),_health:{errcount:0,apisucc:0,apifail:0},circle:!1,cssInserted:!1};function p(){var e,t,n=navigator.connection;return{t:"",page:location.pathname.toLowerCase(),times:1,v:c.appVersion,token:c.token,e:c.environment,begin:(new Date).getTime(),uid:(()=>{var e=localStorage.getItem("leesin_uid")||"";return e||(e=(()=>{for(var e,t,n=20,o=new Array(n),r=Date.now().toString(36).split("");0<n--;)t=(e=36*Math.random()|0).toString(36),o[n]=e%3?t:t.toUpperCase();for(var i=0;i<8;i++)o.splice(3*i+2,0,r[i]);return o.join("")})(),localStorage.setItem("leesin_uid",e)),e})(),sid:u.sid,sr:screen.width+"x"+screen.height,vp:(e=document.documentElement.clientWidth||document.body.clientWidth,t=document.documentElement.clientHeight||document.body.clientHeight,e+"x"+t),ct:n?n.effectiveType:"",ul:(navigator.language||navigator.userLanguage).substr(0,2),_v:"1.0.0",o:location.href}}function n(){}var i=function(e){var t,n=[];for(t in e)e.hasOwnProperty(t)&&n.push(encodeURIComponent(t)+"="+encodeURIComponent(e[t]));return n.join("&")},l=(()=>{var e="object"==typeof console?console.warn:n;try{var t={warn:e};t.warn.call(t)}catch(e){return n}return e})(),s=function(e){return e&&"string"==typeof e?e.replace(/^(https?:)?\/\//,"").replace(/\?.*$/,""):""};var f=function(e,o){return e.reduce(function(e,t,n){return o(t,n)?n:e},-1)};function v(e){var t;"res"!==e.t&&"error"!==e.t&&"behavior"!==e.t&&"health"===e.t&&window&&window.navigator&&"function"==typeof window.navigator.sendBeacon?("object"==typeof(t=e)&&(t=i(t)),t=c.reportUrl+"?"+t,window&&window.navigator&&"function"==typeof window.navigator.sendBeacon?window.navigator.sendBeacon(t):l("[arms] navigator.sendBeacon not surported")):o(e)}function o(e){var t,n=e[e.t];delete e[e.t];var o=c.reportUrl+"?"+i(e),e=((t={})[e.t]=n,t),n=window.__oXMLHttpRequest_||window.XMLHttpRequest;if("function"==typeof n)try{var r=new n;r.open("POST",o,!0),r.setRequestHeader("Content-Type","text/plain"),r.send(JSON.stringify(e))}catch(e){l("[Inner Error] Failed to log, POST请求失败")}else l("[Inner Error] Failed to log, 浏览器不支持XMLHttpRequest")}function e(){var o=!1,r=window.performance||window.mozPerformance||window.msPerformance||window.webkitPerformance,i={addEventListener:function(e,t,n){return window.addEventListener?window.addEventListener(e,t,n):window.attachEvent?window.attachEvent("on"+e,t):void 0},domready:function(e){var t;function n(){r.timing.domInteractive?(clearTimeout(t),e()):t=setTimeout(n,100)}!0!==o&&(t=null,"interactive"===document.readyState?n():document.addEventListener?document.addEventListener("DOMContentLoaded",function(){n()},!1):document.attachEvent&&document.attachEvent("onreadystatechange",function(){n()}))},onload:function(e){var t=null;function n(){r.timing.loadEventEnd?(clearTimeout(t),e(),o=!0):t=setTimeout(n,100)}"complete"===document.readyState?n():i.addEventListener("load",function(){n()},!1)}};i.onload(function(){var e=(e=>{var t;if(r)return{pervPage:n((t=r.timing).fetchStart,t.navigationStart),redirect:n(t.responseEnd,t.redirectStart),dns:n(t.domainLookupEnd,t.domainLookupStart),tcp:n(t.connectEnd,t.connectStart),network:n(t.connectEnd,t.navigationStart),send:n(t.responseStart,t.requestStart),receive:n(t.responseEnd,t.responseStart),request:n(t.responseEnd,t.requestStart),dom:n(t.domComplete,t.domLoading),loadEvent:n(t.loadEventEnd,t.loadEventStart),frontend:n(t.loadEventEnd,t.domLoading),load:n(t.loadEventEnd,t.navigationStart),domReady:n(t.domContentLoadedEventStart,t.navigationStart),interactive:n(t.domInteractive,t.navigationStart),ttfb:n(t.responseStart,t.navigationStart),t:e};function n(e,t){return 0<e&&0<t&&0<=e-t?e-t:void 0}})("onload");console.log(e,"perf"),v(e)})}function t(){var e,t=window.performance||window.mozPerformance||window.msPerformance||window.webkitPerformance;t&&t.getEntries&&(window.PerformanceObserver?(e=function(){var e=t.getEntriesByType("resource"),e={r:"res",t:a(e)};console.log(e,"res"),v(e)},"complete"===document.readyState?e():window.addEventListener("load",e)):new window.PerformanceObserver(function(e){try{var t=e.getEntries();v({r:"res",t:a(t)})}catch(e){console.error(e)}}).observe({entryTypes:["resource"]}))}function r(e,t){return 0<e&&0<t&&0<=e-t?e-t:void 0}function a(e){return e.map(function(e){return m(e)})}function w(){var s=window.onerror,r=(window.onerror=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=e[0],o=e[1],r=e[2],i=e[3],a=(e=>{var t,n,o,r,i=e.column||e.columnNumber,a=e.line||e.lineNumber,s=e.message,d=e.name,e=e.stack;return e?(r=e.match(/https?:\/\/[^\n]+/),r=r?r[0]:"",t="",(n=/https?:\/\/(\S)*\.js/).test(r)&&(t=r.match(n)[0]),o=n=null,(r=r.match(/:(\d+):(\d+)/))&&3<=r.length&&(n=r[1],o=r[2]),{content:e,col:Number(i||n),row:Number(a||o),_errorMessage:void 0,_scriptURI:void 0,_lineNumber:void 0,_columnNumber:void 0,t:void 0,message:s,name:d,resourceUrl:t}):{row:a,col:i,message:s,name:d}})(e[4]);a._errorMessage=n,a._scriptURI=o,a._lineNumber=r,a._columnNumber=i,a.t="err",console.log(a,"normal err"),s&&s.apply(window,e)},window.onunhandledrejection);window.onunhandledrejection=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=e[0],o=n.reason,n={t:n.type||"unhandledrejection",r:o};console.log(n,"promise err"),v(n),r&&r.apply(window,e)}}var m=function(e){return{initiatorType:e.initiatorType,name:e.name,duration:parseInt(e.duration),redirect:r(e.redirectEnd,e.redirectStart),dns:r(e.domainLookupEnd,e.domainLookupStart),connect:r(e.connectEnd,e.connectStart),network:r(e.connectEnd,e.startTime),send:r(e.responseStart,e.requestStart),receive:r(e.responseEnd,e.responseStart),request:r(e.responseEnd,e.requestStart),ttfb:r(e.responseStart,e.requestStart)}};function g(){var o,r,i,a;"function"==typeof window.fetch&&(o=window.fetch,window.__oFetch_=o,window.fetch=function(e,t){var n=1===arguments.length?[e]:Array.apply(null,arguments),r=Date.now(),e=(e&&"string"!=typeof e?e.url:e)||"",i=s(e);return i?o.apply(window,n).then(function(e){var t=e.clone(),n=t.headers;if(n&&"function"==typeof n.get){n=n.get("content-type");if(n&&!/(text)|(json)/.test(n))return e}var o=Date.now()-r;return t.text().then(function(e){t.ok?h(i,!0,o,status,e.substr(0,1e3)||"",r):h(i,!1,o,status,e.substr(0,1e3)||"",r)}),e}):o.apply(window,n)}),"function"==typeof window.XMLHttpRequest&&(r=0,i="",a=window.XMLHttpRequest,window.__oXMLHttpRequest_=a,window.XMLHttpRequest=function(e){var n,t,o=new a(e);return o.addEventListener&&(n=o.open,t=o.send,o.open=function(e,t){e=1===arguments.length?[e]:Array.apply(null,arguments);i=s(t),n.apply(o,e)},o.send=function(){r=Date.now();var e=1===arguments.length?[arguments[0]]:Array.apply(null,arguments);t.apply(o,e)},o.onreadystatechange=function(){if(i&&4===o.readyState){var e=Date.now()-r;if(200<=o.status&&o.status<=299){var t=o.status||200;if("function"==typeof o.getResponseHeader){var n=o.getResponseHeader("Content-Type");if(n&&!/(text)|(json)/.test(n))return}h(i,!0,e,t,o.responseText.substr(0,c.maxLength)||"",r)}else h(i,!1,e,t||"FAILED",o.responseText.substr(0,c.maxLength)||"",r)}}),o})}function h(t,e,n,o,r,i){var a,s;t?(a=e,"error"===(s="api")&&u._health.errcount++,"api"===s&&a&&u._health.apisucc++,"api"!==s||a||u._health.apifail++,s=p(),a=d(d({},s),{t:"api",beigin:i,url:t,success:e,time:n,code:o,msg:r}),-1<f(((s="ignore")&&c[s]||{}).ignoreApis,function(e){return-1<t.indexOf(e)})||(console.log(a,"api"),v(a))):l("[retcode] api is null")}function y(e){this.init(e)}return y.prototype.init=function(e){e&&!e.token?console.warn("[Required]: token is required !"):(e=e,(c=d(d({},c),e)).isPage&&this.sendPerf(),c.enableSPA&&this.addListenRouterChange(),c.isError&&this.addListenJs(),c.isAjax&&this.addListenAjax(),c.isRecord&&this.addRrweb(),c.isBehavior&&this.addListenBehavior(),c.isResource&&this.sendResource())},y.prototype.sendPerf=function(){e()},y.prototype.addListenRouterChange=function(){},y.prototype.addListenJs=function(){w()},y.prototype.addListenAjax=function(){g()},y.prototype.addRrweb=function(){},y.prototype.addListenBehavior=function(){},y.prototype.sendResource=function(){t()},y});
